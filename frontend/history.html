<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - ScamShield</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
</head>
<body class="dashboard-body">
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="logo-icon">üõ°Ô∏è</span>
                <span class="logo-text">ScamShield</span>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html">
                    <span class="nav-icon">üìä</span> Dashboard
                </a>
                <a href="email-scanner.html">
                    <span class="nav-icon">üìß</span> Email Scanner
                </a>
                <a href="url-checker.html">
                    <span class="nav-icon">üîó</span> URL Checker
                </a>
                <a href="history.html" class="active">
                    <span class="nav-icon">üìà</span> History
                </a>
                <a href="settings.html">
                    <span class="nav-icon">‚öôÔ∏è</span> Settings
                </a>
                <a href="#" id="logout-btn">
                    <span class="nav-icon">üö™</span> Logout
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <header class="content-header">
                <h1>üìà Scan History</h1>
                <div class="user-info">
                    <span class="user-name" id="user-name">User</span>
                    <button class="btn-icon">üë§</button>
                </div>
            </header>

            <div class="filter-section">
                <div class="filter-group">
                    <label for="filter-type">Scan Type:</label>
                    <select id="filter-type">
                        <option value="">All Types</option>
                        <option value="email">Email</option>
                        <option value="url">URL</option>
                        <option value="domain">Domain</option>
                        <option value="text">Text</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-risk">Risk Level:</label>
                    <select id="filter-risk">
                        <option value="">All Levels</option>
                        <option value="0">Low</option>
                        <option value="1">Medium</option>
                        <option value="2">High</option>
                        <option value="3">Critical</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-status">Status:</label>
                    <select id="filter-status">
                        <option value="">All Status</option>
                        <option value="safe">Safe</option>
                        <option value="scam">Scam Detected</option>
                    </select>
                </div>
                <button id="apply-filters" class="btn btn-secondary">Apply Filters</button>
                <button id="clear-filters" class="btn btn-outline">Clear</button>
            </div>

            <section class="results-section">
                <div class="results-header">
                    <h2>All Scans</h2>
                    <div class="results-count">
                        <span id="total-count">0</span> results found
                    </div>
                </div>
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Content</th>
                                <th>Risk Score</th>
                                <th>Risk Level</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr>
                                <td colspan="8" class="no-data">No scans yet. Start scanning!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button id="prev-page" class="btn btn-outline" disabled>Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-page" class="btn btn-outline" disabled>Next</button>
                </div>
            </section>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication
        if (!auth.requireAuth()) {
            // Will redirect to login
        }

        // Load user info
        const user = auth.getUser();
        if (user && user.username) {
            document.getElementById('user-name').textContent = user.username;
        }

        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        const pageSize = 20;

        // Load history
        async function loadHistory(page = 1) {
            try {
                const type = document.getElementById('filter-type').value;
                const risk = document.getElementById('filter-risk').value;
                const status = document.getElementById('filter-status').value;
                
                const params = new URLSearchParams({
                    page: page,
                    page_size: pageSize
                });
                
                if (type) params.append('scan_type', type);
                if (risk) params.append('risk_level', risk);
                if (status) params.append('is_scam', status === 'scam');
                
                const response = await fetch(`/api/scan/history?${params}`, {
                    headers: auth.getAuthHeaders()
                });
                
                const data = await response.json();
                
                currentPage = data.page || 1;
                totalPages = Math.ceil((data.total || 0) / pageSize);
                
                renderHistory(data.scans || []);
                updatePagination();
                
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        function renderHistory(scans) {
            const tbody = document.getElementById('history-body');
            document.getElementById('total-count').textContent = scans.length;
            
            if (scans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="no-data">No scans found</td></tr>';
                return;
            }
            
            tbody.innerHTML = scans.map(scan => `
                <tr>
                    <td>${new Date(scan.created_at).toLocaleString()}</td>
                    <td>${scan.scan_type}</td>
                    <td class="content-cell" title="${scan.content || ''}">${truncate(scan.content || '', 40)}</td>
                    <td>${Math.round((scan.risk_score || 0) * 100)}%</td>
                    <td><span class="risk-badge risk-${scan.risk_level}">${getRiskLabel(scan.risk_level)}</span></td>
                    <td>${scan.category || '-'}</td>
                    <td>${scan.is_scam ? '‚ö†Ô∏è Scam' : '‚úÖ Safe'}</td>
                    <td>
                        <button class="btn-icon" onclick="viewDetails('${scan.scan_id}')" title="View Details">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function getRiskLabel(level) {
            const labels = ['Low', 'Medium', 'High', 'Critical'];
            return labels[level] || 'Unknown';
        }

        function truncate(text, length) {
            if (!text) return '-';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function updatePagination() {
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        function viewDetails(scanId) {
            alert(`View details for scan: ${scanId}`);
            // Could open a modal or navigate to detail page
        }

        // Event listeners
        document.getElementById('apply-filters').addEventListener('click', () => loadHistory(1));
        document.getElementById('clear-filters').addEventListener('click', () => {
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-risk').value = '';
            document.getElementById('filter-status').value = '';
            loadHistory(1);
        });
        document.getElementById('prev-page').addEventListener('click', () => loadHistory(currentPage - 1));
        document.getElementById('next-page').addEventListener('click', () => loadHistory(currentPage + 1));

        // Initial load
        loadHistory();
    </script>
</body>
</html>
